Redactor.add("plugin","ai",{translations:{en:{ai:{"placeholder-image":"Describe the image you want to generate.","placeholder-text":"Tell me what you want to write.",send:"Send",stop:"Stop",discard:"Discard",insert:"Insert",prompt:"Prompt","image-style":"Image style","change-tone":"Change tone"}}},dropdowns:{items:{improve:{title:"Improve it",command:"ai.set",params:{prompt:"Improve it"}},simplify:{title:"Simplify it",command:"ai.set",params:{prompt:"Simplify it"}},fix:{title:"Fix any mistakes",command:"ai.set",params:{prompt:"Fix any mistakes"}},shorten:{title:"Make it shorter",command:"ai.set",params:{prompt:"Make it shorter"}},detailed:{title:"Make it more detailed",command:"ai.set",params:{prompt:"Make it more detailed"}},complete:{title:"Complete sentence",command:"ai.set",params:{prompt:"Complete sentence"}},tone:{title:"Change tone",command:"ai.popupTone"},translate:{title:"Translate",command:"ai.popupTranslate"}}},defaults:{tone:["Academic","Assertive","Casual","Confident","Constructive","Empathetic","Exciting","Fluent","Formal","Friendly","Inspirational","Professional"],style:["3d model","Digital art","Isometric","Line art","Photorealistic","Pixel art"],translate:["Arabic","Chinese","English","French","German","Greek","Italian","Japanese","Korean","Portuguese","Russian","Spanish","Swedish","Ukrainian"],size:{"1792x1024":"Landscape","1024x1792":"Portrait","1024x1024":"Square"},text:{stream:!0},image:{save:!1},makeit:"Make it",translateto:"Translate to",spinner:'<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_nOfF{animation:spinner_qtyZ 2s cubic-bezier(0.36,.6,.31,1) infinite}.spinner_fVhf{animation-delay:-.5s}.spinner_piVe{animation-delay:-1s}.spinner_MSNs{animation-delay:-1.5s}@keyframes spinner_qtyZ{0%{r:0}25%{r:3px;cx:4px}50%{r:3px;cx:12px}75%{r:3px;cx:20px}100%{r:0;cx:20px}}</style><circle class="spinner_nOfF" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_fVhf" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_piVe" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_MSNs" cx="4" cy="12" r="3"/></svg>'},observe(t,e,s){if(("ai-tools"!==e||this.opts.is("ai.text.url"))&&("ai-image"!==e||this.opts.is("ai.image.url")))return t},popup(t,e){"addbar"!==this.app.ui.getState().type?(this.app.dropdown.create("ai-tools",{items:this.opts.get("ai.items")||this.dropdowns.items}),this.app.dropdown.open(t,e)):this._buildPrompt()},promptImage(t,e){this._buildPrompt({image:!0})},popupTone(t,e){var s={},i=this.opts.get("ai.tone")||this.defaults.tone,a=this.opts.get("ai.makeit")||this.defaults.makeit;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:a+" "+i[t]}};this.app.dropdown.create("ai-tone",{items:s}),this.app.dropdown.open(t,e)},popupTranslate(t,e){var s={},i=this.opts.get("ai.translate")||this.defaults.translate,a=this.opts.get("ai.translateto")||this.defaults.translateto;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:a+" "+i[t]}};this.app.dropdown.create("ai-translate",{items:s}),this.app.dropdown.open(t,e)},set(t,e){this.promptButton=e;let s=this._getText(),i=this._getHtml();""!==s&&!0!==t.empty&&this.promptButton.setIcon(this.defaults.spinner),t.empty&&(s="",i="",this.promptButton.setIcon(this.defaults.spinner));e=t.empty?"":t.prompt,e=this.app.broadcast("ai.create",{prompt:e}).get("prompt");this._setPrompt(s,i,e,t.empty)},sendPrompt(e){e.preventDefault(),e.stopPropagation();var e=this.opts.get("ai."+this.promptType+".model"),s=this._getMessage();if(""!==s){var i=this._getTone(s),i=("text"===this.promptType&&(this.conversation.push({role:"user",content:s}),i)&&this.conversation.push({role:"user",content:i}),{model:e,stream:this.opts.get("ai.text.stream"),messages:this.conversation});let t="1024x1024";"image"===this.promptType&&(t=this.$size.val());s=this.app.broadcast("ai.create",{prompt:s}).get("prompt"),i="image"===this.promptType?{model:e,n:1,size:t,prompt:s}:i;this.$progress.html(this.defaults.spinner),"image"!==this.promptType&&this.opts.is("ai.text.stream")?this._sendStream(this.$preview,s,!0):this._sendPrompt(i,"_complete")}},insertPrompt(t){t.preventDefault(),t.stopPropagation();let e=this.app.create("insertion"),s=this.$preview.html();t=this.app.broadcast("ai.before.insert",{html:s});s=t.get("html");let i=this.savedInstance?this.savedInstance.getBlock():this.$prompt,a=this.savedInstance?"after":"before",r=!this.savedInstance;setTimeout(function(){this.app.block.setTool(!1);var t=e.insert({html:s,target:i,position:a,remove:r});this.$prompt.remove(),this.conversation=[],this.app.broadcast("ai.insert",{nodes:t})}.bind(this),3)},stopPrompt(t,e){t&&(t.preventDefault(),t.stopPropagation(),e=this.$preview.text(),this.isEvent)&&this.isEvent.close(),this.$preview.css({"white-space":""}),this.$preview.html(this._parseReply(e)),this.$insert.show(),this.$stop.hide(),this.$generate.show();var s=t?"ai.stop":"ai.complete",i=this.$previewLabel.text(),t=t?{prompt:i}:{prompt:i,response:this._parseReply(e)};this.app.broadcast(s,t)},closePrompt(t){t.preventDefault(),t.stopPropagation(),this.app.block.setTool(!1),this.$prompt.remove(),this.conversation=[],this.isEvent&&this.isEvent.close(),this.app.broadcast("ai.discard")},_getTone(t){var e=this.$select.val();return"0"!==e&&"1"!==e&&`${this.opts.get("ai.makeit")||this.defaults.makeit} `+e},_getHtml(){let e="",s=this.app.blocks.get({selected:!0,instances:!0});var t=this.app.block.get();0===s.length&&t&&(s=[t]);for(let t=0;t<s.length;t++)e+=s[t].getOuterHtml();return e},_getText(){let e="",s=this.app.blocks.get({selected:!0,instances:!0});var i,t=this.app.block.get();0===s.length&&t&&(s=[t]);for(let t=0;t<s.length;t++)s[t].isEditable()&&(i=s[t].getType(),e=e+("listitem"===i?"- ":"")+s[t].getPlainText()+"\n");return e=(e=e.trim()).replace(/\n$/,"")},_getMessage(){return this.$textarea.val().trim()},_getNode(){var t=this.app.block.create().getBlock();return this._buildNode(t,{traverse:!0})},_getInsertedNode(){let t=this.dom('<div class="rx-inserted-node" style="white-space: pre-wrap;">');return t.html(this.opts.get("ai.spinner")),t=this._buildNode(t,{traverse:!1})},_setPrompt(t,e,s,i){""===t&&!0!==i||(this.promptType="text",this.promptText=t,this.promptHtml=e,i=[{role:"user",content:t},{role:"user",content:s}],e={model:this.opts.get("ai."+this.promptType+".model"),messages:i},this.opts.is("ai.text.stream")?((t=this._getInsertedNode()).html(this.defaults.spinner),this.app.dropdown.close(),this.app.context.close(),this._sendStream(t,i)):this._sendPrompt(e,"_insert"))},_sendPrompt(t,e){let s={url:this.opts.get("ai."+this.promptType+".endpoint"),data:JSON.stringify(t)};t=this.app.create("utils");s=t.extendData(s,this.opts.get("ai."+this.promptType+".data")),this.ajax.request("post",{url:this.opts.get("ai."+this.promptType+".url"),data:s,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:s}).isStopped())return!1}.bind(this),success:this[e].bind(this),error:this._error.bind(this)})},_sendStream(s,t,i){var e=this.opts.get("ai."+this.promptType+".model"),a=this.opts.get("ai."+this.promptType+".endpoint"),r=this.opts.get("ai."+this.promptType+".url"),e={model:e,stream:this.opts.get("ai.text.stream"),messages:i?this.conversation:t},t={url:a,data:JSON.stringify(e)},t=this.app.create("utils").extendData(t,this.opts.get("ai."+this.promptType+".data"));let o="",p=this._createSource(r,t),n=(this.isEvent=p,this.currentIndex=0,this.app.scroll.getTarget());s.removeClass("rx-inserted-node-started"),p.addEventListener("message",function(t){this.app.dropdown.close(),this.app.context.close();var t=t.data,e=t.indexOf(": ","data")+2,e=t.slice(e,t.length);"[DONE]"===e?this._sendStreamDone(p,s,o,i):(e=JSON.parse(e)).notification?this._sendStreamDone(p,s,e.notification,i):(t=e.choices)&&0<t.length&&(e=t[0].delta.content)&&(s.hasClass("rx-inserted-node-started")||(s.html(""),this._sendStreamPreviewSet(i)),o+=e,this._typeCharacter(s,o),this._isElementBottomBeyond(s.get())&&(s.get().scrollIntoView(!1),n.scrollTop(n.scrollTop()+20)),s.addClass("rx-inserted-node-started"))}.bind(this)),p.addEventListener("error",function(t){this._error(t),p.close(),this.isEvent=!1}.bind(this))},_sendStreamDone(t,e,s,i){if(i){let t=setInterval(function(){this.currentIndex===s.length&&(clearInterval(t),this.stopPrompt(!1,s),this.conversation.push({role:"assistant",content:s}))}.bind(this),100)}else this._insertAfterNode(e,s);t.close(),this.isEvent=!1},_sendStreamPreviewSet(t){t&&(t=this.$textarea.val(),this.$progress.html(""),this.$previewLabel.html(this._sanitize(t)),this.$textarea.val(""),this.$preview.html(""),this.$preview.css({"white-space":"pre-wrap"}),this.$generate.hide(),this.$stop.show())},_buildNode(t,e){let s;var i;return this.instance=!1,this.app.blocks.is()?(this.app.editor.isSelectAll()||(s=(s=this.app.blocks.get({first:!0,selected:!0})).closest("[data-rx-first-level]")).before(t),i=this.app.editor.isSelectAll(),s=this.app.blocks.removeAll(),i&&(t=s)):(this.instance=this.app.block.get(),this.instance||(this.instance=this.app.block.create(),this.app.blocks.get({first:!0}).before(this.instance.getBlock())),this.instance.isType("listitem")?this.instance.getBlock().html("").append(t):this.instance.isType("todoitem")?this.instance.getContentItem().html("").append(t):(this.instance.getBlock().before(t),this.instance.remove(e))),t},_buildPrompt(t){this.savedInstance=!1,this.conversation=[],this.$prompt=this._createPrompt(t),this.$textarea.on("input focus",function(){this.app.block.setTool("ai")}.bind(this));let e=this.app.block.get();var s,i,t=this.app.blocks.is();this.app.dropdown.close(),this.app.context.close(),e||t?(s=["layout","table","quote","list","todo","image","embed"],s=(e=t?this.app.blocks.get({last:!0,selected:!0,instances:!0}):e).getBlock().closest("[data-rx-type="+s.join("],[data-rx-type=")+"]"),i=e.getBlock().closest("[data-rx-type=column]"),0!==s.length&&(0!==i.length&&(this.savedInstance=e),e=s.dataget("instance")),this._insertPrompt(this.$prompt,e),t&&this.app.blocks.unset()):this._insertPrompt(this.$prompt),this.app.editor.adjustHeight()},_error(t,e){var s=this.app.editor.getEditor().find(".rx-inserted-node");0!==s.length&&(this.app.dropdown.close(),this.app.context.close(),this.app.create("insertion").insert({target:s,remove:!0,caret:"end",html:this.promptHtml})),this.$progress&&this.$progress.fadeOut(500,function(){this.$progress.html("").removeAttr("style")}.bind(this)),this.app.broadcast("ai.error",t||e)},_insert(t){if(this.promptButton.setIcon(""),t.error)return this._error(t.error.message,t);if(!t.choices)return this._error(t);var t=t.choices[0].message.content,e=this._parseReply(t),s=this.app.create("insertion"),e=this.app.broadcast("ai.before.insert",{html:e}).get("html");this.app.dropdown.close(),this.app.context.close();let i;var a=this.instance&&this.instance.isType(["listitem","todoitem"]);i=a?(this.instance.setContent(t),this.instance.getBlock()):(a=this._getNode(),this.app.block.set(a),s.insert({html:e,caret:"end"})),this.app.broadcast("ai.insert",{nodes:i})},_complete(t){var s=this.$textarea.val();if(this.$progress.html(""),this.$previewLabel.html(""),t.error)return this._error(t.error.message,t);if(t.notification)this.$preview.html(t.notification+"<br>");else if(this.$previewLabel.html(this._sanitize(s)),this.$textarea.val(""),this.$textarea.focus(),"text"===this.promptType){if(!t.choices)return this._error(t);s=t.choices[0].message.content,this.conversation.push({role:"assistant",content:s}),s=this._parseReply(s),this.$preview.html(s=s),this.$insert.show();var i=this.$previewLabel.text();this.app.broadcast("ai.complete",{prompt:i,response:s}),this.app.editor.adjustHeight()}else if("image"===this.promptType){if(!t.data)return this._error(t);i=t.data[0].url,s=this.opts.get("ai.image.save");if(s){t=this.app.create("utils");let e={url:i};e=t.extendData(e,this.opts.get("ai."+this.promptType+".data")),this.ajax.request("post",{url:s,data:e,before:function(t){if(this.app.broadcast("ai.before.save",{xhr:t,data:e}).isStopped())return!1}.bind(this),success:function(t){this.app.broadcast("ai.save",t),this._completeImage(t.filename)}.bind(this),error:this._error.bind(this)})}else this._completeImage(i)}},_completeImage(t){var t=this.dom("<img>").attr("src",t),e=t.get().outerHTML,t=(this.$preview.html(t),this.$insert.show(),this.$previewLabel.text());this.app.broadcast("ai.complete",{prompt:t,response:e}),this.app.editor.adjustHeight()},_parseReply(t){var e=this.app.create("utils"),s=this.app.create("cleaner");let i=e.parseMarkdown(t);return i=s.store(i,"lists"),i=s.store(i,"headings"),i=s.store(i,"images"),i=s.store(i,"links"),i=this._parseMarkdown(i),i=s.restore(i,"lists"),i=s.restore(i,"headings"),i=s.restore(i,"images"),i=(i=(i=(i=s.restore(i,"links")).replace(/<p><(ul|ol)>/g,"<$1>")).replace(/<\/(ul|ol)><\/p>/g,"</$1>")).replace(/<p><\/p>/g,"")},_createPrompt(t){t=Redactor.extend(!0,{},{image:!1},t),this.promptType=t.image?"image":"text";var t=this.lang.get("ai.placeholder-"+this.promptType),e=(this.app.editor.getEditor().find(".rx-ai-main").remove(),this.dom('<div class="rx-in-tool rx-ai-main">').attr({contenteditable:!1})),s=this.dom('<div class="rx-ai-body">'),i=this.dom('<div class="rx-ai-footer">'),a=this.dom('<div class="rx-ai-buttons">');return this.$progress=this.dom('<div class="rx-ai-progress">'),this.$previewLabel=this.dom('<div class="rx-ai-preview-label">'),this.$preview=this.dom('<div class="rx-ai-preview">'),this.$prompt=this.dom('<div class="rx-ai-prompt">'),this.$label=this.dom('<label class="rx-ai-label">').html(this.lang.get("ai.prompt")),this.$textarea=this.dom('<textarea class="rx-ai-textarea rx-form-textarea">').attr({placeholder:t}),this.$select=this.dom('<select class="rx-ai-select rx-form-select">'),this.$size=this.dom('<select class="rx-ai-size rx-form-select">'),this._createPromptFooter(i,a),this.$prompt.append(this.$label),this.$prompt.append(this.$textarea),s.append(this.$progress),s.append(this.$previewLabel),s.append(this.$preview),s.append(this.$prompt),e.append(s),e.append(i),e},_createPromptFooter(t,e){this._createTone(this.$select),this._createSize(this.$size),this._createPromptButtons(e),t.append(this.$select),"image"===this.promptType&&t.append(this.$size),t.append(e)},_createPromptButton(t){return this.dom('<button class="rx-ai-button rx-form-button">').html(t)},_createSize(t){var e,s,i=this.opts.get("ai.size");for([e,s]of Object.entries(i)){var a=this.dom("<option>").val(e).html(s);t.append(a)}},_createTone(e){var s="image"===this.promptType?this.opts.get("ai.style")||this.defaults.style:this.opts.get("ai.tone")||this.defaults.tone,i="image"===this.promptType?this.lang.get("ai.image-style"):this.lang.get("ai.change-tone"),a=this.dom("<option>").val(0).html(i);e.append(a),a=this.dom("<option>").val(1).html("---"),e.append(a);for(let t=0;t<s.length;t++)i=this.lang.parse(s[t]),a=this.dom("<option>").val(i).html(i),e.append(a)},_createPromptButtons(t){this.$generate=this._createPromptButton(this.lang.get("ai.send")).addClass("rx-form-button-primary").on("click.rx-ai",this.sendPrompt.bind(this)),this.$stop=this._createPromptButton(this.lang.get("ai.stop")).addClass("rx-form-button-primary").on("click.rx-ai",this.stopPrompt.bind(this)).hide(),this.$discard=this._createPromptButton(this.lang.get("ai.discard")).addClass("rx-form-button-danger").on("click.rx-ai",this.closePrompt.bind(this)),this.$insert=this._createPromptButton(this.lang.get("ai.insert")).on("click.rx-ai",this.insertPrompt.bind(this)).hide(),t.append(this.$discard),t.append(this.$insert),t.append(this.$stop),t.append(this.$generate)},_createSource(t,e){const i=new EventTarget;let a=this.ajax.post({url:t,data:e,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:e}).isStopped())return!1}.bind(this)}).xhr,r=this;var o=!1,p=0;return a.onprogress=function(){var t,e;if(o||(o=!0,i.dispatchEvent(new Event("open",{status:a.status,headers:a.getAllResponseHeaders(),url:a.responseUrl}))),r._isJsonString(a.responseText)){var s=JSON.parse(a.responseText);if(s.error)return r._error(s.error.message,s),void i.close()}for(;0<=(t=a.responseText.indexOf("\n\n",p));)e=a.responseText.slice(p,t),p=t+2,e.length&&i.dispatchEvent(new MessageEvent("message",{data:e}))},i.close=function(){a.abort()},i},_isElementBottomBeyond(t){var e=this.app.scroll.getTarget(),t=t.getBoundingClientRect();return t.top+t.height>e.get().innerHeight},_isJsonString(t){try{JSON.parse(t)}catch(t){return!1}return!0},_insertAfterNode(t,e){let s;var i,a=this.instance&&this.instance.isType(["listitem","todoitem"]);e=this.app.broadcast("ai.before.insert",{html:e}).get("html"),s=a?(this.instance.setContent(e),this.instance.getBlock()):(a=this.app.create("insertion"),i=this.app.block.create().getBlock(),e=this._parseReply(e),t.after(i),t.remove(),this.app.block.set(i),a.insert({html:e,caret:"end"})),this.app.broadcast("ai.insert",{nodes:s})},_insertPrompt(t,e,s){var i=this.app.create("element");let a="after";e||(a="top"===this.opts.get("addPosition")?(e=this.app.blocks.get({first:!0,instances:!0}),"before"):(e=this.app.blocks.get({last:!0,instances:!0}),"after")),e.getBlock()[a](t),i.scrollTo(t),this.app.observer.observeUnset(),this.$textarea.focus(),this.$textarea.on("input.rx-ai-autoresize keyup.rx-ai-autoreize",this._resize.bind(this)),this.$textarea.on("keydown.rx-ai-event",this._promptKeydown.bind(this))},_promptKeydown(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendPrompt(t))},_typeCharacter(t,e){this.currentIndex<e.length&&(t.get().textContent+=e.charAt(this.currentIndex),this.currentIndex++,this.app.editor.adjustHeight(),setTimeout(function(){this._typeCharacter(t,e)}.bind(this),100))},_resize(){this.$textarea.css("height","auto"),this.$textarea.css("height",this.$textarea.get().scrollHeight+"px"),this.app.editor.adjustHeight()},_sanitize(t){return t.replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;"}})},_parseMarkdown(t){let e=!1,s="";var t=t.split("\n"),i=this.opts.get("replaceTags");for(const a of t)a.startsWith("```")?(e=!e,s+=e?this._replaceCodeLine(a):"</code></pre>"):a.startsWith("####_")?s+=a:s+=e?this._escapeHtml(a)+"\n":`<p>${this._escapeHtml(a)}</p>`;t=i.b||"b",i=i.i||"i";return s=(s=(s=s.replace(/\*\*\_(.*?)\_\*\*/g,"<"+t+"><"+i+">$1</"+i+"></"+t+">")).replace(/\*\*(.*?)\*\*/g,"<"+t+">$1</"+t+">")).replace(/\*(.*?)\*/g,"<"+i+">$1</"+i+">")},_replaceCodeLine(t){return t.replace(/\`\`\`(([^\s]+))?/gm,function(t,e,s){return"<pre"+(s?' class="'+s+'"':"")+"><code>"})},_escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,t=>e[t])}});